<!DOCTYPE html>
<html lang="en">

<style>
    .btn, .permission-btn {
        display: block;
        margin: 0;
        padding: -15px;
        margin-bottom: 0px;
    }

    .btn:hover, .permission-btn:hover {
        opacity: 0.70;
    }

</style>
<script src="//code.jquery.com/jquery-1.11.3.min.js"></script>


<a class="btn" href="https://towertalk.jiveon.com/support" target="_top">
    <img src="https://towertalk.jiveon.com/resources/statics/1002/NewHere4.png?a=1443039727218"/>
</a>

<a class="btn" href="https://towertalk.jiveon.com/docs/DOC-1133" target="_top">
    <img src="https://towertalk.jiveon.com/resources/statics/1002/4GUIDLINES.png?a=1443039522471"/>
</a>

<a class="permission-btn" href="#">
    <img src="https://towertalk.jiveon.com/resources/statics/1002/3Representitive.png?a=1443039036457"/>
</a>

<script>
    window._config = {};
    //Put names of the groups here
    window._config.groupA = 'TowerGarden Distributors (Verified)';
    window._config.linkA = 'https://towertalk.jiveon.com/community/distributor-enablement';
    window._config.default = "https://towertalk.jiveon.com/docs/DOC-1171";

    var button = document.body.querySelector('.permission-btn');
    console.log('Starting permissions code');
    $(document).ready(function () {
        button.addEventListener('click', function () {
            var request1 = RESTWrapper.prototype.get("/api/core/v3/people/@me");
            $.when(request1).then(function (data1) {
                console.log(data1);
                return data1.id;
            }).then(function (userID) {
                var request2 = RESTWrapper.prototype.get("/api/core/v3/people/" + userID + "/securityGroups");
                $.when(request2).then(function (data2) {
                    console.log(data2);
                    //if array is not empty do this:
                    if (data2.list.length > 0) {
                        for (var i = 0; i < data2.list.length; i++) {
                            //if found &&  if not
                            if (data2.list[i].name == window._config.groupA) {
                                window.parent.location.href = window._config.linkA;
                            } else {
                                console.log(window._config.default);
                                window.parent.location.href = window._config.default;
                            }
                        }
                        //if array is empty go to:
                    } else {
                        console.log(window._config.default);
                        window.parent.location.href = window._config.default;
                    }
                })
            })
        })
    });

    // LIBRARY FROM MISHA TO WORK WITH AJAX IN JIVE
    if (!window.RESTWrapper) {
        RESTWrapper = function (win, version) {
            this.win = (typeof win == 'undefined') ? window : win;
            this.version = 'v' + (typeof version == 'undefined' ? 3 : version);
        };
        RESTWrapper.prototype = {
            _query: function (method, url, params) {
                var chunks = url.split('?');
                if (chunks[0].indexOf('/api/core/') == -1) url = '/api/core' + url;
                var def = jQuery.Deferred();
                if (method == 'post' || method == 'put') {
                    var ajax = jQuery.ajax({
                        dataType: 'text',
                        contentType: 'application/json',
                        url: url,
                        data: JSON.stringify(params),
                        type: method
                    });
                } else {
                    var ajax = jQuery.ajax({dataType: 'text', url: url, data: params, type: method});
                }
                ajax.done(function (result) {
                    if (typeof result != 'undefined') {
                        result = JSON.parse(result.replace("throw 'allowIllegalResourceCall is false.';", ''));
                    }
                    def.resolve(result);
                    answer = result;
                });
                ajax.fail(function (a, b, c) {
                    console.error('fail:', a, b, c);
                    answer = a;
                    def.reject(a)
                });
                return def.promise();
            },
            get: function (url, data) {
                return this._query('get', url, data)
            },
            post: function (url, data) {
                return this._query('post', url, data)
            },
            put: function (url, data) {
                return this._query('put', url, data)
            },
            delete: function (url, data) {
                return this._query('delete', url, data)
            },
            find: function (typeString, visibleID) {
                var typeID;
                var placeIDs = [4, 14, 600];
                var typeIDs = {
                    "community": 14,
                    "space": 14,
                    "group": 4,
                    "project": 600,
                    "discussion": 1,
                    "thread": 1,
                    "document": 102
                };
                var typeID = typeIDs[typeString];
                return this.get((placeIDs.indexOf(typeID) != -1 ? '/places' : '/contents') + '?filter=entityDescriptor(' + typeID + ', ' + visibleID + ')');
            },
            printFind: function (typeString, visibleID) {
                this.find(typeString, visibleID).then(function (data) {
                    console.log(data.list[0])
                })
            }
        };
    }
    window.rest = window.rest || new RESTWrapper(window, 3);
</script>


