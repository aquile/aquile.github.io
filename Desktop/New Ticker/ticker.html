<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <style>
        @font-face {
            font-family: Lucida Sans Regular;
            src: url(Lucida%20Sans%20Regular.ttf);
        }
    </style>
    <link rel="stylesheet" href="reset.css" type="text/css"/>
    <link rel="stylesheet" href="liMarquee.css" type="text/css"/>
    <script src="jquery-1.9.0.min.js"></script>
    <script src="jquery.liMarquee.js"></script>
    <script src="http://twitter.github.com/hogan.js/builds/3.0.1/hogan-3.0.1.min.js"></script>

    <script>
        window._config = {
            docID: '6548'
        };
        var Templates = {
            Ticker: Hogan.compile(document.querySelector('.template__latest_post').innerHTML)
        };

        var Ajax = {
            getJSON: function (url, callback) {
                var xhr = new XMLHttpRequest();
                xhr.open('GET', url, true);
                xhr.send();

                xhr.onreadystatechange = function () {
                    if (xhr.readyState != 4) return;
                    callback(JSON.parse(xhr.responseText))
                };
            }
        };

        function MakeTicker() {
            Ajax.getJSON('/api/core/v3/contents/' + window._config.docID, function (geoData) {
                objects = geoData.response.GeoObjectCollection.featureMember.map(function (fm) {
                    //console.log(geoData);
                    var go = fm.GeoObject,
                            cordinates = go.Point.pos.split(' ');
                    cities = {
                        name: go.name,
                        description: go.description,
                        kind: go.metaDataProperty.GeocoderMetaData.kind,
                        longitude: cordinates[1].slice(0, 4),
                        latitude: cordinates[0].slice(0, 4)
                    };

                    return cities;
                });
                document.querySelector('.str_wrap').innerHTML = Templates.Ticker.render({
                    cityObj: objects
                });
            });
        }
    </script>

    <script>
        if (!window.RESTWrapper) {
            RESTWrapper = function (win, version) {
                this.win = (typeof win == 'undefined') ? window : win;
                this.version = 'v' + (typeof version == 'undefined' ? 3 : version);
            };

            RESTWrapper.prototype = {
                _query: function (method, url, params) {

                    var chunks = url.split('?');

                    if (chunks[0].indexOf('/api/core/' + this.version) == -1) url = '/api/core/' + this.version + url;

                    var def = jQuery.Deferred();

                    if (method == 'post' || method == 'put') {
                        var ajax = jQuery.ajax({
                            dataType: 'text',
                            contentType: 'application/json',
                            url: url,
                            data: JSON.stringify(params),
                            type: method
                        });
                    } else {
                        var ajax = jQuery.ajax({dataType: 'text', url: url, data: params, type: method});
                    }
                    ajax.done(function (result) {
                        if (typeof result != 'undefined') {
                            result = JSON.parse(result.replace("throw 'allowIllegalResourceCall is false.';", ''));
                        }
                        def.resolve(result);
                    });
                    ajax.fail(function (a, b, c) {
                        console.error('fail:', a, b, c);
                        def.reject(a)
                    });
                    return def.promise();
                },

                get: function (url, data) {
                    return this._query('get', url, data)
                },

                post: function (url, data) {
                    return this._query('post', url, data)
                },

                put: function (url, data) {
                    return this._query('put', url, data)
                },

                delete: function (url, data) {
                    return this._query('delete', url, data)
                },

                find: function (typeString, visibleID) {
                    var typeID;

                    var placeIDs = [4, 14, 600];

                    var typeIDs = {
                        "community": 14,
                        "space": 14,
                        "group": 4,
                        "project": 600,
                        "discussion": 1,
                        "thread": 1,
                        "document": 102
                    };

                    var typeID = typeIDs[typeString];

                    return this.get((placeIDs.indexOf(typeID) != -1 ? '/places' : '/contents') + '?filter=entityDescriptor(' + typeID + ', ' + visibleID + ')');
                },

                printFind: function (typeString, visibleID) {
                    this.find(typeString, visibleID).then(function (data) {
                        console.log(data.list[0])
                    })
                }
            };
        }

        window.rest = window.rest || new RESTWrapper(window, 3);
    </script>


</head>
<body>


<div class="wrapper">
    <div class="latest_post">latest post</div>
    <div class="str_wrap">

        <a href="#" target="_top">Этим летом мне посчастливилось... </a>
        <a href="#" target="_top">А потом посчастливилось осенью... </a>
        <a href="#" target="_top">Сбрось мне ресет, которым ты пользуешься... </a>
    </div>
    <div class="counter">1 of 5</div>
</div>

<script type="text/x-handlebars-template" class="template__latest_post">
    {{#cityObj}}
    <a href="{{link}}" target="_top">{{description}}</a>
    {{/cityObj}}
</script>

<script>
    $(window).load(function () {
        $('.str_wrap').liMarquee();
    });
</script>

</body>
</html>