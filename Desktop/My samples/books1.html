<script>
    window._config = {
        docID: '6548'
    }
</script>
<link href="https://fonts.googleapis.com/css?family=Roboto:500,900italic,900,400italic,100,700italic,300,700,500italic,100italic,300italic,400&amp;subset=cyrillic,cyrillic-ext,latin,latin-ext" rel="stylesheet" type="text/css">
<link href="https://fonts.googleapis.com/css?family=Roboto:500,900italic,900,400italic,100,700italic,300,700,500italic,100italic,300italic,400&amp;subset=cyrillic,cyrillic-ext,latin,latin-ext" rel="stylesheet" type="text/css">
<style>
    *{
        font-family: Roboto, Arial, Helvetica, sans-serif;
    }
    body{
        background: #f7f7f7;
    }
    header{
        padding: 10px 0;
        background: #ffd500;
        font-size: 30px;
        text-align: center;
        font-weight: 600;
    }
    ul{
        list-style: none;
        height: 180px;
        padding: 0;
    }
    .text *:first-child {
        font-size: 14px;
    }
    li:hover{
        -ms-filter: "progid:DXImageTransform.Microsoft.Alpha(Opacity=70)";
        filter: alpha(opacity=70);
        -moz-opacity: 0.7;
        -khtml-opacity: 0.7;
        opacity: 0.7;
    }
    li{
        padding: 24px 10px 24px 20px;
        text-transform: uppercase;
    }
    a strong{
        font-weight: 600;
    }
    a{
        color: #000000;
        text-decoration: none;
        font-weight: 400;
    }
    a:nth-child(odd) li{
        background: #f4f3e6;
    }
    .description{
        display: none;
    }
    .total{
        text-align: center;
        padding: 20px 0 5px 0;
    }
    .bar-value{
        position: absolute;
        left: 42.2%;
        top: 199px;
        font-weight: bold;
    }
    .indicator{
        background: url(/resources/statics/3057/bar-arrow.png?a=14s3s492669551ee61);
        width: 20px;
        height: 100px;
        display: BLOCK;
        background-repeat: no-repeat;
        position: absolute;
        top: 116px;
        left: 45%;
        -ms-transform: rotate(1310deg);
        -webkit-transform: rotate(1310deg);
        transform: rotate(1310deg);
    }
    .text {
        max-width: 110px;
        display: inline-block;
        word-wrap: break-word;
    }
    .round{
        float: right;
        border-radius: 50%;
        width: 45px;
        margin: 10px 12px;
        height: 16px;
        text-align: center;
        font-size: 14px;
        padding: 14px 0;
        color: #ffffff;
        font-weight: 500;
        position: absolute;
        right: 0;
    }

    .green{background: #4eb55d;}
    .orange{background: #ffc000;}
    .red{background: #e11309;}

</style>
<script type="text/javascript" src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mustache.js/0.8.1/mustache.min.js"></script>
<script>

    function appendTooltip(){

        var tooltip = $('<div class="kpi-tooltip"></div>')



        $(window.parent.document).find('body')
                .append(tooltip);


        $( "<style>" +
                ".kpi-tooltip { display: none; position: absolute; background: #ffd500; padding: 20px; z-index: 99; max-width: 200px; font-family: Roboto, Arial, Helvetica, sans-serif;}" +
                " .kpi-tooltip:after { width: 0; height: 0; border-top: 28px solid transparent; border-bottom: 28px solid transparent; border-left: 28px solid #ffd500; content: \"\"; position: absolute;   right: -28px; top: 0;}" +
                "</style>" ).appendTo( $(window.parent.document).find("head") )
    }
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
    function getDocument(){
        return $.Deferred(function(defer) {
            $.ajax({
                type: 'GET',
                url: '/api/core/v3/contents/'+window._config.docID,
                contentType: "application/json",
                dataType:'json',
                success: function(json) {
                    defer.resolve(json);
                },
                error: function(json) {
                    defer.reject(json);
                }
            });
        }).promise();
    }

    function render(rows,total){
        var items = {total: total,items: rows}
        var tmpl = $('#scr_rows').html();
        var out = Mustache.render(tmpl, items);
        $('#content').html(out);
        setPersent( parseInt($('.total').attr('data-total')))
        setTimeout(adjustCircles,700);
    }

    function adjustCircles(){
        $('.round').each(function(ind,el){
            $(el).css('top',$(el).parent().parent().offset().top + ( $(el).parent().parent().height()-$(el).height() )/2 )
        })
        resizeMe();
    }


    function setPersent(x){

        var zero = 1306;
        var deg = zero+(x*270/100);


        $({deg: zero }).animate({deg: deg}, {
            step: function(now, fx){
                $('.indicator').css({
                    "-ms-transform": "rotate("+now+"deg)",
                    "-webkit-transform": "rotate("+now+"deg)",
                    "transform":"rotate("+now+"deg)"
                });
            }, duration: 1000
        });

    }

    $(function(){
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

        appendTooltip()

        getDocument().always(function(data){
            var response = $.parseJSON(data.responseText.replace('throw \'allowIllegalResourceCall is false.\';', ''));
            var content = response.content.text.replace(/\<\!--(.*?)--\>/gi,'');

            var total = $(content).find('table[data-kpi-total="true"] td').text();
            var rows = $(content).find('table[data-kpi="true"] tr').slice(1,content.length);

            console.log('content: ', rows, 'total: ', total);

            var rowsObj = [];
            $.each(rows, function(ind, el){

                var title       = $(el).find('td').eq(0).html(),
                        description = $(el).find('td').eq(1).html(),
                        value       = $(el).find('td').eq(2).text(),
                        color       = $(el).find('td').eq(3).text(),
                        link        = $(el).find('td').eq(4).html().match(/href=\"(.*?)\"/)[1];


                rowsObj.push({title: title,description: description, value: value, color: color, link: link})

            })


            render(rowsObj, total)

        })


        $('body').on('mouseleave','li', function(){
            // if (e.target.outerHTML.indexOf('kpi-tooltip') == -1 ){
            $(window.parent.document).find('.kpi-tooltip').hide()
            //}

        })

        $('body').on('mouseenter','li', function(){
            console.log('test')
            var thisLeft = $(this).offset().left,
                    thisTop = $(this).offset().top,
                    frameLeft = $(window.frameElement).offset().left,
                    frameTop = $(window.frameElement).offset().top,
                    description = $(this).find('.description').html()

            $(window.parent.document).find('.kpi-tooltip').html(description).show()

            var leftK = ($(window.parent.document).find('.kpi-tooltip').width() == 200) ? 255 : 120;
            console.log($(window.parent.document).find('.kpi-tooltip').width(),leftK)
            $(window.parent.document).find('.kpi-tooltip').css({
                left: frameLeft+thisLeft - leftK,
                top: frameTop+thisTop + 5
            })


        })

    })
</script>
<script id="scr_rows" type="text/html">
    <header>KPI</header>
    <div class="total" data-total="{{total}}">
        <img src="/resources/statics/3057/barometr.png?a=1434966955161">
        <i class="indicator"></i>
        <span class="bar-value">{{total}}%</span>
    </div>
    <ul>
        {{#items}}
        <a href="{{link}}" target="_top">

            <li>
                <div class="text">
                    {{{title}}}
                    <span class="round {{color}}">{{value}}</span>
                </div>
                <span class="description">{{{description}}}</span>
            </li>
        </a>

        {{/items}}
    </ul>
</script>
<div id="content" class="kpi"></div>